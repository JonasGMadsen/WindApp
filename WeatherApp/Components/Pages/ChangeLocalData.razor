@page "/change-local-data"
@inject IWebHostEnvironment WebHostEnvironment
@inject NavigationManager NavigationManager

<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header" style="background-color: #4B0082; color: white;">
            <h3 class="mb-0">Change Local Wind Data</h3>
        </div>
        <div class="card-body">
            <div class="text-center mb-4">
                <label class="btn btn-outline-primary btn-lg">
                    <span class="bi bi-upload me-2"></span> Select Wind Data File
                    <InputFile OnChange="HandleFileSelected" style="display: none;" />
                </label>
            </div>
            <p class="text-center fs-5">
                <span class="@GetStatusClass()">@statusMessage</span>
            </p>
        </div>
    </div>
</div>

@code {
    private string statusMessage = string.Empty;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null)
        {
            statusMessage = "No file selected.";
            StateHasChanged();
            return;
        }

        var filePath = Path.Combine(WebHostEnvironment.WebRootPath, "data", "winddata.json");
        try
        {
            await using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50 MB file limit. Files should at most be around 10-30 MB, this is just in case
            await using var fileStream = new FileStream(filePath, FileMode.Create);
            await stream.CopyToAsync(fileStream);

            statusMessage = "Wind data file updated successfully.";
            StateHasChanged();

            await Task.Delay(3000); // a small delay for user feedback
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            statusMessage = $"Error updating file: {ex.Message}";
            StateHasChanged();
        }
    }

    private string GetStatusClass()
    {
        if (statusMessage.Contains("successfully"))
            return "text-success fw-bold";
        if (statusMessage.Contains("Error"))
            return "text-danger fw-bold";
        return "text-secondary";
    }
}